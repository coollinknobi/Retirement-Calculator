<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>AI Êô∫ËÉΩÈÄÄ‰ºëÂ∞éËà™ (ÂÖ¨ÈñãÁâà)</title>
    
    <!-- PWA Icon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üöÄ</text></svg>">

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Microsoft JhengHei", sans-serif; touch-action: manipulation; }
        @media print {
            .no-print { display: none !important; }
            .print-block { display: block !important; }
            body { background: white; }
        }
        .print-block { display: none; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 18px; width: 18px; border-radius: 50%; background: #3b82f6; margin-top: -7px; cursor: pointer; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #e2e8f0; border-radius: 2px; }
        .prose h1, .prose h2 { font-weight: bold; color: #1e3a8a; font-size: 1.1em; margin: 0.5em 0; }
        .prose ul { list-style: disc; padding-left: 1.2em; }
        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- Icons ---
        const Icon = ({ path, size = 16, className = "", onClick }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} onClick={onClick} style={{cursor: onClick?'pointer':'default'}}>{path}</svg>
        );
        const Icons = {
            Brain: <path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z" />,
            Settings: <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z M12 9a3 3 0 1 0 0 6 3 3 0 0 0 0-6z" />,
            Wallet: <g><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4" /><path d="M3 5v14a2 2 0 0 0 2 2h16v-5" /><path d="M18 12a2 2 0 0 0 0 4h4v-4Z" /></g>,
            CreditCard: <g><rect width="20" height="14" x="2" y="5" rx="2" /><line x1="2" x2="22" y1="10" y2="10" /></g>,
            Globe: <g><circle cx="12" cy="12" r="10" /><line x1="2" x2="22" y1="12" y2="12" /><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" /></g>,
            Printer: <g><path d="M6 9V2h12v7" /><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2" /><path d="M6 14h12v8H6z" /></g>,
            Save: <g><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" /><polyline points="17 21 17 13 7 13 7 21" /><polyline points="7 3 7 8 15 8" /></g>,
            AlertCircle: <g><circle cx="12" cy="12" r="10" /><line x1="12" x2="12" y1="8" y2="12" /><line x1="12" x2="12.01" y1="16" y2="16" /></g>,
            Percent: <g><line x1="19" x2="5" y1="5" y2="19" /><circle cx="6.5" cy="6.5" r="2.5" /><circle cx="17.5" cy="17.5" r="2.5" /></g>,
            PieChart: <g><path d="M21.21 15.89A10 10 0 1 1 8 2.83" /><path d="M22 12A10 10 0 0 0 12 2v10z" /></g>,
            TrendingUp: <g><polyline points="22 7 13.5 15.5 8.5 10.5 2 17" /><polyline points="16 7 22 7 22 13" /></g>,
            ChevronDown: <path d="m6 9 6 6 6-6" />,
            ChevronUp: <path d="m18 15-6-6-6 6" />,
            RotateCcw: <g><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" /><path d="M3 3v5h5" /></g>,
            Plus: <g><line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" /></g>,
            Trash: <g><polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /></g>,
            Sparkles: <g><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z" /><path d="M5 3v4" /><path d="M9 5H5" /><path d="M5 21v-4" /><path d="M9 19H5" /></g>,
            MessageCircle: <path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z" />,
            Send: <g><line x1="22" y1="2" x2="11" y2="13" /><polygon points="22 2 15 22 11 13 2 9 22 2" /></g>,
            Key: <g><circle cx="7.5" cy="15.5" r="5.5" /><path d="m21 2-9.6 9.6" /><path d="m15.5 7.5 3 3L22 7l-3-3" /></g>,
            Heart: <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z" />,
            Activity: <polyline points="22 12 18 12 15 21 9 3 6 12 2 12" />,
            Calendar: <g><rect x="3" y="4" width="18" height="18" rx="2" ry="2" /><line x1="16" y1="2" x2="16" y2="6" /><line x1="8" y1="2" x2="8" y2="6" /><line x1="3" y1="10" x2="21" y2="10" /></g>,
            X: <g><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></g>,
            Download: <g><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" y1="15" x2="12" y2="3" /></g>,
            Upload: <g><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="17 8 12 3 7 8" /><line x1="12" y1="3" x2="12" y2="15" /></g>,
            BarChart: <g><line x1="12" y1="20" x2="12" y2="10" /><line x1="18" y1="20" x2="18" y2="4" /><line x1="6" y1="20" x2="6" y2="16" /></g>,
            Layers: <g><polygon points="12 2 2 7 12 12 22 7 12 2" /><polyline points="2 17 12 22 22 17" /><polyline points="2 12 12 17 22 12" /></g>,
            AlertTriangle: <g><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" /><line x1="12" y1="9" x2="12" y2="13" /><line x1="12" y1="17" x2="12.01" y2="17" /></g>,
            Home: <g><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" /><polyline points="9 22 9 12 15 12 15 22" /></g>,
            Maximize: <g><path d="M15 3h6v6" /><path d="M9 21H3v-6" /><path d="M21 3l-7 7" /><path d="M3 21l7-7" /></g>,
            Edit: <g><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" /><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" /></g>
        };
        const SimpleIcon = ({ name, className, onClick }) => <Icon path={Icons[name]||Icons.Settings} className={className} onClick={onClick} />;

        // --- Components ---
        const ChartComponent = ({ type, data, options, height = 300 }) => {
            const canvasRef = useRef(null);
            const chartInstanceRef = useRef(null);
            useEffect(() => {
                if (!canvasRef.current) return;
                if (chartInstanceRef.current) chartInstanceRef.current.destroy();
                const ctx = canvasRef.current.getContext('2d');
                chartInstanceRef.current = new Chart(ctx, { type, data, options: { ...options, maintainAspectRatio: false } });
                return () => { if (chartInstanceRef.current) chartInstanceRef.current.destroy(); };
            }, [type, data, options]);
            return <div className="chart-container" style={{ height: height, width: '100%' }}><canvas ref={canvasRef}></canvas></div>;
        };

        const Modal = ({ isOpen, onClose, title, content, maxWidth = "max-w-lg" }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm" onClick={onClose}>
                    <div className={`bg-white rounded-xl shadow-2xl w-full ${maxWidth} max-h-[90vh] flex flex-col`} onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center p-4 border-b bg-slate-50 rounded-t-xl">
                            <h3 className="font-bold text-slate-800 flex items-center gap-2"><SimpleIcon name="Sparkles" className="text-blue-600"/> {title}</h3>
                            <button onClick={onClose}><SimpleIcon name="X" className="text-slate-400 hover:text-slate-600"/></button>
                        </div>
                        <div className="p-6 overflow-y-auto prose prose-sm text-slate-600 leading-relaxed" dangerouslySetInnerHTML={{ __html: marked.parse(content || '') }}></div>
                        <div className="p-4 border-t flex justify-end"><button onClick={onClose} className="bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700">ÈóúÈñâ</button></div>
                    </div>
                </div>
            );
        };

        const formatCompactNumber = (val) => {
            const num = Number(val);
            if (!num && num !== 0) return '';
            if (num >= 100000000) return (num / 100000000).toFixed(1) + 'ÂÑÑ';
            if (num >= 10000) return (num / 10000).toFixed(1) + 'Ëê¨';
            return (num / 1000).toFixed(1) + 'k';
        };

        // Standard SliderInput (With blue number)
        const SliderInput = ({ label, value, onChange, min, max, step, unit = '', showCompact = true }) => (
            <div className="mb-3">
                <div className="flex justify-between items-center mb-1">
                    <label className="text-xs text-slate-600 whitespace-nowrap mr-2 min-w-[60px]">{label}</label>
                    <div className="flex items-center gap-2 flex-1 justify-end min-w-0">
                        <div className="flex items-center gap-1 bg-white rounded border border-slate-300 px-1 w-24 justify-between flex-shrink-0">
                            <input 
                                type="number" 
                                value={value} 
                                onChange={(e) => onChange(e.target.value)} 
                                className="w-full text-right text-xs py-1 focus:outline-none bg-transparent"
                            />
                            <span className="text-[10px] text-slate-400 flex-shrink-0">{unit}</span>
                        </div>
                        {showCompact && <span className="text-[10px] text-blue-500 w-10 text-right flex-shrink-0 overflow-hidden text-ellipsis">{formatCompactNumber(value)}</span>}
                    </div>
                </div>
                <input type="range" min={min} max={max} step={step} value={value} onChange={(e) => onChange(e.target.value)} className="w-full" />
            </div>
        );

        // Compact Timeline Input (NO blue number, stacked vertically for better fit in grid)
        const CompactTimelineInput = ({ label, value, onChange, min, max, step = 1, unit = '' }) => (
            <div className="flex flex-col gap-1 mb-1">
                <div className="flex justify-between items-end">
                    <label className="text-[10px] text-slate-500 font-medium">{label}</label>
                    <div className="flex items-center gap-0.5">
                        <input 
                            type="number" 
                            value={value} 
                            onChange={(e) => onChange(Number(e.target.value))} 
                            className="w-8 text-right text-xs font-bold bg-transparent border-b border-slate-200 focus:border-blue-500 outline-none p-0"
                        />
                        <span className="text-[10px] text-slate-400">{unit}</span>
                    </div>
                </div>
                <input 
                    type="range" 
                    min={min} max={max} step={step} 
                    value={value} 
                    onChange={(e) => onChange(Number(e.target.value))} 
                    className="w-full h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer"
                />
            </div>
        );

        // --- Logic ---
        const calculatePMT = (principal, annualRate, months) => {
            if (months <= 0 || principal <= 0) return 0;
            if (annualRate <= 0) return principal / months;
            const r = annualRate / 100 / 12;
            return Math.round(principal * (r * Math.pow(1 + r, months)) / (Math.pow(1 + r, months) - 1));
        };

        const calculateTaiwanTax = (annualIncome) => {
            const deduction = 423000; const taxable = Math.max(0, annualIncome - deduction);
            if (taxable <= 590000) return taxable * 0.05;
            if (taxable <= 1330000) return taxable * 0.12 - 41300;
            if (taxable <= 2660000) return taxable * 0.20 - 147700;
            if (taxable <= 4980000) return taxable * 0.30 - 413700;
            return taxable * 0.40 - 911700;
        };

        const EXPENSE_LABELS = { food: 'È£≤È£ü', housing: 'Â±Ö‰Ωè', transport: '‰∫§ÈÄö', education: 'ÊïôËÇ≤', medical: 'ÈÜ´ÁôÇ', clothing: 'Ë°£Ëëó', insurance: '‰øùÈö™', entertainment: 'Â®õÊ®Ç', pets: 'ÂØµÁâ©', misc: 'ÈõúÈ†Ö', shopping: 'Ë≥ºÁâ©', lifestyle: 'ÁîüÊ¥ª' };

        // --- App ---
        const RetirementApp = () => {
            const STORAGE_KEY = 'RETIREMENT_APP_DATA_V35_CLEAN';
            
            const DEFAULT_EXPENSES = {
                food: 0, housing: 0, transport: 0, lifestyle: 0, 
                education: 0, entertainment: 0, shopping: 0, pets: 0, 
                medical: 0, insurance: 0, misc: 0 
            };

            const DEFAULT_STATE = {
                apiKey: '', currency: 'TWD', exchangeRate: 1,
                currentYear: new Date().getFullYear(), currentAge: 30, retirementAge: 60, lifeExpectancy: 90,
                incomeDetails: { monthly: 0, other: 0, bonusMonths: 0, growth: 0, growthEndAge: 55, maxMonthly: 0 },
                spouseIncomeDetails: { monthly: 0, other: 0, bonusMonths: 0, growth: 0, growthEndAge: 55, maxMonthly: 0 },
                taxSettings: { mode: 'auto', manualRate: 0 },
                assets: { cashTW: 0, cashFX: 0, stockTW: 0, stockUS: 0, crypto: 0, other: 0, spouseCash: 0, spouseStock: 0, spouseRealEstate: 0 },
                realEstateList: [],
                loans: [],
                expenseDetails: DEFAULT_EXPENSES,
                cpi: 2.0, investmentReturn: 5.0, propertyGrowth: 2.0,
                reinvestRatio: 100,
                events: []
            };

            const loadState = (key, fallback) => {
                try {
                    const saved = localStorage.getItem(STORAGE_KEY);
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        return parsed[key] !== undefined ? parsed[key] : fallback;
                    }
                } catch (e) { }
                return fallback;
            };

            const [apiKey, setApiKey] = useState(() => loadState('apiKey', DEFAULT_STATE.apiKey));
            const [currency, setCurrency] = useState(() => loadState('currency', DEFAULT_STATE.currency));
            const [exchangeRate, setExchangeRate] = useState(() => loadState('exchangeRate', DEFAULT_STATE.exchangeRate));
            const [currentYear, setCurrentYear] = useState(() => Number(loadState('currentYear', DEFAULT_STATE.currentYear)));
            const [currentAge, setCurrentAge] = useState(() => Number(loadState('currentAge', DEFAULT_STATE.currentAge)));
            const [retirementAge, setRetirementAge] = useState(() => loadState('retirementAge', DEFAULT_STATE.retirementAge));
            const [lifeExpectancy, setLifeExpectancy] = useState(() => loadState('lifeExpectancy', DEFAULT_STATE.lifeExpectancy));
            const [incomeDetails, setIncomeDetails] = useState(() => loadState('incomeDetails', DEFAULT_STATE.incomeDetails));
            const [spouseIncomeDetails, setSpouseIncomeDetails] = useState(() => loadState('spouseIncomeDetails', DEFAULT_STATE.spouseIncomeDetails));
            const [taxSettings, setTaxSettings] = useState(() => loadState('taxSettings', DEFAULT_STATE.taxSettings));
            const [assets, setAssets] = useState(() => loadState('assets', DEFAULT_STATE.assets));
            const [realEstateList, setRealEstateList] = useState(() => loadState('realEstateList', DEFAULT_STATE.realEstateList));
            const [loans, setLoans] = useState(() => loadState('loans', DEFAULT_STATE.loans));
            const [expenseDetails, setExpenseDetails] = useState(() => loadState('expenseDetails', DEFAULT_STATE.expenseDetails));
            const [cpi, setCpi] = useState(() => loadState('cpi', DEFAULT_STATE.cpi));
            const [investmentReturn, setInvestmentReturn] = useState(() => loadState('investmentReturn', DEFAULT_STATE.investmentReturn));
            const [propertyGrowth, setPropertyGrowth] = useState(() => loadState('propertyGrowth', DEFAULT_STATE.propertyGrowth));
            const [reinvestRatio, setReinvestRatio] = useState(() => loadState('reinvestRatio', DEFAULT_STATE.reinvestRatio));
            const [events, setEvents] = useState(() => loadState('events', DEFAULT_STATE.events));
            
            const [sensitivityMode, setSensitivityMode] = useState('none');
            const [chartType, setChartType] = useState('trend'); 
            const [showExchangeSettings, setShowExchangeSettings] = useState(false);
            const [aiMessage, setAiMessage] = useState("ÈªûÊìä„ÄåÁîüÊàêÂ†±Âëä„ÄçÁç≤ÂèñÂàÜÊûê");
            const [isAiLoading, setIsAiLoading] = useState(false);
            const [healthScore, setHealthScore] = useState(0);
            const [showSettings, setShowSettings] = useState(true);
            const [activeTab, setActiveTab] = useState('assets');
            const [showChat, setShowChat] = useState(false);
            const [chatMessages, setChatMessages] = useState([{role: 'ai', text: 'ÊàëÊòØÊÇ®ÁöÑ AI Ë≤°ÂãôÁÆ°ÂÆ∂ÔºåË´ãËº∏ÂÖ•ÊÇ®ÁöÑÂïèÈ°å„ÄÇ'}]);
            const [chatInput, setChatInput] = useState('');
            const [isChatLoading, setIsChatLoading] = useState(false);
            const [lastSaved, setLastSaved] = useState(null);
            const [modalOpen, setModalOpen] = useState(false);
            const [modalContent, setModalContent] = useState("");
            const [isMarketAnalyzing, setIsMarketAnalyzing] = useState(false);
            const [aiModalOpen, setAiModalOpen] = useState(false); 

            const [editingEventId, setEditingEventId] = useState(null);
            const [newEventName, setNewEventName] = useState('');
            const [newEventAmount, setNewEventAmount] = useState(100000);
            const [newEventType, setNewEventType] = useState('expense');
            const [newEventAge, setNewEventAge] = useState(60);
            const [newEventDuration, setNewEventDuration] = useState(1);

            useEffect(() => {
                const data = { apiKey, currency, exchangeRate, currentYear, currentAge, retirementAge, lifeExpectancy, incomeDetails, spouseIncomeDetails, taxSettings, assets, realEstateList, loans, expenseDetails, cpi, investmentReturn, propertyGrowth, reinvestRatio, events };
                const timer = setTimeout(() => { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); setLastSaved(new Date().toLocaleTimeString()); }, 1000);
                return () => clearTimeout(timer);
            }, [apiKey, currency, exchangeRate, currentYear, currentAge, retirementAge, lifeExpectancy, incomeDetails, spouseIncomeDetails, taxSettings, assets, realEstateList, loans, expenseDetails, cpi, investmentReturn, propertyGrowth, reinvestRatio, events]);

            const addLoan = () => setLoans([...loans, { id: Date.now(), name: 'Êñ∞Ë≤∏Ê¨æ', balance: 1000000, rate: 2.0, months: 240 }]);
            const removeLoan = (id) => setLoans(loans.filter(l => l.id !== id));
            const updateLoan = (id, f, v) => setLoans(loans.map(l => l.id === id ? { ...l, [f]: v } : l));

            const addRealEstate = () => setRealEstateList([...realEstateList, { id: Date.now(), name: 'Êñ∞ÊàøÁî¢', value: 10000000, growth: 1.5 }]);
            const removeRealEstate = (id) => setRealEstateList(realEstateList.filter(r => r.id !== id));
            const updateRealEstate = (id, f, v) => setRealEstateList(realEstateList.map(r => r.id === id ? { ...r, [f]: v } : r));
            
            const handleAddOrUpdateEvent = () => {
                if(!newEventName) return alert("Ë´ãËº∏ÂÖ•‰∫ã‰ª∂ÂêçÁ®±");
                if (editingEventId) {
                    setEvents(events.map(e => e.id === editingEventId ? { ...e, name: newEventName, type: newEventType, amount: Number(newEventAmount), startAge: Number(newEventAge), duration: Number(newEventDuration) } : e));
                    setEditingEventId(null);
                } else {
                    setEvents([...events, { id: Date.now(), name: newEventName, type: newEventType, amount: Number(newEventAmount), startAge: Number(newEventAge), duration: Number(newEventDuration) }]);
                }
                setNewEventName(''); setNewEventAmount(100000); setNewEventType('expense'); setNewEventAge(60); setNewEventDuration(1);
            };
            const startEditEvent = (ev) => { setEditingEventId(ev.id); setNewEventName(ev.name); setNewEventAmount(ev.amount); setNewEventType(ev.type); setNewEventAge(ev.startAge); setNewEventDuration(ev.duration); };
            const cancelEditEvent = () => { setEditingEventId(null); setNewEventName(''); setNewEventAmount(100000); };
            const removeEvent = (id) => { setEvents(events.filter(e => e.id !== id)); if(editingEventId === id) cancelEditEvent(); };

            const handleExport = () => {
                const data = { apiKey, currency, exchangeRate, currentYear, currentAge, retirementAge, lifeExpectancy, incomeDetails, spouseIncomeDetails, taxSettings, assets, realEstateList, loans, expenseDetails, cpi, investmentReturn, propertyGrowth, reinvestRatio, events };
                const blob = new Blob([JSON.stringify(data)], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `retirement_config_${new Date().toISOString().slice(0,10)}.json`;
                a.click(); URL.revokeObjectURL(url);
            };
            const handleImport = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if(data.currentAge) setCurrentAge(Number(data.currentAge));
                        if(data.currentYear) setCurrentYear(Number(data.currentYear));
                        if(data.assets) setAssets(data.assets);
                        if(data.realEstateList) setRealEstateList(data.realEstateList);
                        if(data.loans) setLoans(data.loans);
                        if(data.incomeDetails) setIncomeDetails(data.incomeDetails);
                        if(data.spouseIncomeDetails) setSpouseIncomeDetails(data.spouseIncomeDetails);
                        if(data.expenseDetails) setExpenseDetails(data.expenseDetails);
                        if(data.apiKey) setApiKey(data.apiKey);
                        if(data.reinvestRatio) setReinvestRatio(data.reinvestRatio);
                        if(data.events) setEvents(data.events);
                        alert("ÂåØÂÖ•ÊàêÂäüÔºÅ");
                    } catch(err) { alert("Ê™îÊ°àÊ†ºÂºèÈåØË™§"); }
                };
                reader.readAsText(file);
            };

            const monthlyExpensesBase = useMemo(() => Object.values(expenseDetails).reduce((a, b) => a + b, 0), [expenseDetails]);
            const totalLiabilities = useMemo(() => loans.reduce((acc, l) => acc + l.balance, 0), [loans]);
            
            const totalLiquidAssets = useMemo(() => assets.cashTW + assets.cashFX + assets.stockTW + assets.stockUS + assets.crypto + assets.spouseCash + assets.spouseStock, [assets]);

            const initialInvested = useMemo(() => assets.stockTW + assets.stockUS + assets.crypto + assets.spouseStock, [assets]);
            const initialCash = useMemo(() => assets.cashTW + assets.cashFX + assets.spouseCash, [assets]);
            
            const totalMonthlyDebtPayment = useMemo(() => loans.reduce((acc, l) => acc + calculatePMT(l.balance, l.rate, l.months), 0), [loans]);

            const totalRealEstateValue = useMemo(() => realEstateList.reduce((acc, r) => acc + r.value, 0), [realEstateList]);

            const calculatedSurplus = useMemo(() => {
                const monthlyIncome = incomeDetails.monthly + (incomeDetails.other || 0) + spouseIncomeDetails.monthly + (spouseIncomeDetails.other || 0);
                const grossYearly = (monthlyIncome * 12) + (incomeDetails.monthly * incomeDetails.bonusMonths) + (spouseIncomeDetails.monthly * spouseIncomeDetails.bonusMonths);
                const monthlyTax = calculateTaiwanTax(grossYearly) / 12;
                return Math.max(0, monthlyIncome - monthlyExpensesBase - totalMonthlyDebtPayment - monthlyTax);
            }, [incomeDetails, spouseIncomeDetails, monthlyExpensesBase, totalMonthlyDebtPayment]);

            const simulationData = useMemo(() => {
                const startYear = Number(currentYear); const startAge = Number(currentAge);
                const yearsToSimulate = Math.max(1, lifeExpectancy - startAge);
                const labels = []; const liquidAssetsData = []; const netWorthData = []; const debtData = []; const targetData = [];
                const annualIncomeData = []; const annualExpenseData = []; 
                const specialIncomeData = []; const specialExpenseData = []; 
                const compositionData = { cash: [], stock: [], realEstate: [], spouse: [], crypto: [] }; 
                const velocityData = [];

                let currentInvested = initialInvested;
                let currentCash = initialCash;
                let currentRealEstateList = realEstateList.map(r => ({...r, currentValue: r.value}));
                let currentOtherRealEstate = assets.other; 
                let currentSpouseRE = assets.spouseRealEstate; 
                let currentLoansSim = loans.map(l => ({ ...l, currentBalance: l.balance, monthlyPayment: calculatePMT(l.balance, l.rate, l.months) }));
                
                const totalInitInvested = Math.max(1, initialInvested);
                const ratioStock = totalInitInvested > 0 ? (assets.stockTW + assets.stockUS) / totalInitInvested : 0;
                const ratioCrypto = totalInitInvested > 0 ? assets.crypto / totalInitInvested : 0;
                const ratioSpouseInv = totalInitInvested > 0 ? assets.spouseStock / totalInitInvested : 0;
                
                let incomeMult = 1.0, expenseMult = 1.0, cpiMult = 1.0, investMult = 1.0;
                if (sensitivityMode === 'income-10') incomeMult = 0.9;
                else if (sensitivityMode === 'income-20') incomeMult = 0.8;
                else if (sensitivityMode === 'income-30') incomeMult = 0.7;
                else if (sensitivityMode === 'exp+10') expenseMult = 1.1;
                else if (sensitivityMode === 'exp+20') expenseMult = 1.2;
                else if (sensitivityMode === 'exp+30') expenseMult = 1.3;
                else if (sensitivityMode === 'inc-20_exp+20') { incomeMult = 0.8; expenseMult = 1.2; }
                else if (sensitivityMode === 'inc-30_exp+30') { incomeMult = 0.7; expenseMult = 1.3; }
                else if (sensitivityMode === 'inv-20') investMult = 0.8;
                else if (sensitivityMode === 'inv-40') investMult = 0.6;
                else if (sensitivityMode === 'cpi+20') cpiMult = 1.2;
                else if (sensitivityMode === 'cpi+40') cpiMult = 1.4;

                let effectiveCPI = cpi * cpiMult;
                let effectiveReturn = investmentReturn * investMult;

                let currentMonthlyIncome = (incomeDetails.monthly + (incomeDetails.other || 0)) * incomeMult;
                let currentSpouseMonthlyIncome = (spouseIncomeDetails.monthly + (spouseIncomeDetails.other || 0)) * incomeMult;
                let currentMonthlyExpenses = monthlyExpensesBase * expenseMult;
                let success = true, bankruptYear = null;
                
                let prevTotalLiquid = currentInvested + currentCash;

                for (let i = 0; i <= yearsToSimulate; i++) {
                    const thisAge = startAge + i;
                    labels.push(`${startYear + i} (${thisAge}Ê≠≤)`);
                    
                    let myAnnualGross = 0;
                    let spouseAnnualGross = 0;

                    if (thisAge < retirementAge) {
                         myAnnualGross = (currentMonthlyIncome * 12) + (currentMonthlyIncome * incomeDetails.bonusMonths);
                         spouseAnnualGross = (currentSpouseMonthlyIncome * 12) + (spouseIncomeDetails.monthly * spouseIncomeDetails.bonusMonths * incomeMult);
                    }
                    let totalAnnualGross = myAnnualGross + spouseAnnualGross;

                    let tax = taxSettings.mode === 'auto' ? calculateTaiwanTax(totalAnnualGross) : totalAnnualGross * (taxSettings.manualRate / 100);
                    let annualNet = totalAnnualGross - tax;
                    
                    let annualDebtService = 0, totalLoanBal = 0;
                    currentLoansSim.forEach(loan => {
                        let pay = 0;
                        if (loan.currentBalance > 0) {
                            for(let m=0; m<12; m++) {
                                if (loan.currentBalance <= 0) break;
                                const interest = loan.currentBalance * (loan.rate/100/12);
                                let pmt = loan.monthlyPayment;
                                let princ = pmt - interest;
                                if (princ > loan.currentBalance) { princ = loan.currentBalance; pmt = princ + interest; loan.currentBalance = 0; }
                                else { loan.currentBalance -= princ; }
                                pay += pmt;
                            }
                        }
                        annualDebtService += pay;
                        totalLoanBal += loan.currentBalance;
                    });

                    let annualSpecialIncome = 0;
                    let annualSpecialExpense = 0;
                    events.forEach(ev => {
                        if (thisAge >= ev.startAge && thisAge < ev.startAge + ev.duration) {
                            const futureVal = ev.amount * Math.pow(1 + effectiveCPI/100, i);
                            if (ev.type === 'income') annualSpecialIncome += futureVal;
                            else annualSpecialExpense += futureVal;
                        }
                    });

                    let annualLiving = currentMonthlyExpenses * 12;
                    let totalAnnualExpenditure = annualLiving + annualDebtService + annualSpecialExpense;
                    let totalAnnualInflow = annualNet + annualSpecialIncome;
                    
                    let netCashflow = totalAnnualInflow - totalAnnualExpenditure;
                    
                    if (netCashflow > 0) {
                        const toInvest = netCashflow * (reinvestRatio / 100);
                        const toCash = netCashflow - toInvest;
                        currentInvested = currentInvested * (1 + effectiveReturn/100) + toInvest;
                        currentCash = currentCash * 1.005 + toCash;
                    } else {
                        currentInvested = currentInvested * (1 + effectiveReturn/100);
                        currentCash = currentCash * 1.005;
                        const deficit = Math.abs(netCashflow);
                        if (currentCash >= deficit) {
                            currentCash -= deficit;
                        } else {
                            const remainingDeficit = deficit - currentCash;
                            currentCash = 0;
                            currentInvested -= remainingDeficit;
                        }
                    }

                    let totalCurrentREValue = 0;
                    currentRealEstateList.forEach(r => {
                        r.currentValue *= (1 + r.growth/100);
                        totalCurrentREValue += r.currentValue;
                    });
                    currentOtherRealEstate *= (1 + propertyGrowth/100); 
                    currentSpouseRE *= (1 + propertyGrowth/100);
                    
                    const totalRE = totalCurrentREValue + currentOtherRealEstate + currentSpouseRE;
                    const totalLiquid = currentInvested + currentCash;
                    
                    velocityData.push(Math.round(totalLiquid - prevTotalLiquid));
                    prevTotalLiquid = totalLiquid;

                    if (totalLiquid < 0 && success) { success = false; bankruptYear = startYear + i; }
                    
                    liquidAssetsData.push(Math.round(totalLiquid));
                    netWorthData.push(Math.round(totalLiquid + totalRE - totalLoanBal));
                    debtData.push(Math.round(totalLoanBal));
                    
                    annualIncomeData.push(Math.round(annualNet));
                    annualExpenseData.push(Math.round(annualLiving + annualDebtService));
                    specialIncomeData.push(Math.round(annualSpecialIncome));
                    specialExpenseData.push(Math.round(annualSpecialExpense));

                    compositionData.cash.push(Math.round(currentCash));
                    const currStock = currentInvested * ratioStock;
                    const currCrypto = currentInvested * ratioCrypto;
                    const currSpouseInv = currentInvested * ratioSpouseInv;
                    compositionData.stock.push(Math.round(currStock));
                    compositionData.crypto.push(Math.round(currCrypto));
                    compositionData.realEstate.push(Math.round(totalRE));
                    const initialCashTotal = Math.max(1, initialCash);
                    compositionData.spouse.push(Math.round(currentSpouseRE + currSpouseInv + (assets.spouseCash * (currentCash/initialCashTotal))));

                    if (thisAge < incomeDetails.growthEndAge && currentMonthlyIncome < incomeDetails.maxMonthly) {
                        currentMonthlyIncome *= (1 + incomeDetails.growth/100);
                    }
                    if (thisAge < spouseIncomeDetails.growthEndAge && currentSpouseMonthlyIncome < spouseIncomeDetails.maxMonthly) {
                        currentSpouseMonthlyIncome *= (1 + spouseIncomeDetails.growth/100);
                    }
                    
                    currentMonthlyExpenses *= (1 + effectiveCPI/100);
                }
                
                let tempExp = monthlyExpensesBase * expenseMult;
                for (let i = 0; i <= yearsToSimulate; i++) {
                    const remaining = lifeExpectancy - (startAge + i);
                    const annualExp = tempExp * 12;
                    const realR = (1 + effectiveReturn/100)/(1 + effectiveCPI/100) - 1;
                    let req = (Math.abs(realR) < 0.001) ? annualExp * remaining : annualExp * (1 - Math.pow(1+realR, -remaining))/realR;
                    targetData.push(Math.round(req + debtData[i]));
                    tempExp *= (1 + effectiveCPI/100);
                }
                return { labels, liquidAssetsData, netWorthData, debtData, targetData, annualIncomeData, annualExpenseData, specialIncomeData, specialExpenseData, compositionData, velocityData, finalLiquid: (currentInvested + currentCash), success, bankruptYear };
            }, [currentYear, currentAge, retirementAge, lifeExpectancy, initialInvested, initialCash, assets, loans, incomeDetails, spouseIncomeDetails, monthlyExpensesBase, taxSettings, cpi, investmentReturn, propertyGrowth, sensitivityMode, reinvestRatio, events, realEstateList]);

            useEffect(() => {
                const idx = retirementAge - currentAge;
                if (idx < 0 || idx >= simulationData.liquidAssetsData.length) return;
                const liquid = simulationData.liquidAssetsData[idx];
                const target = simulationData.targetData[idx];
                setHealthScore(Math.min(100, Math.max(0, target > 0 ? (liquid/target)*100 : 100)));
            }, [simulationData, retirementAge, currentAge]);

            const callGemini = async (text) => {
                if (!apiKey) { alert("Ë´ãÂÖàËº∏ÂÖ•ÊÇ®ÁöÑ API Key„ÄÇ"); return null; }
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ contents: [{ parts: [{ text }] }] })
                    });
                    const data = await res.json();
                    if(data.error) throw new Error(data.error.message);
                    return data.candidates[0].content.parts[0].text;
                } catch(e) { 
                    alert("AI ÈÄ£Á∑öÈåØË™§: " + e.message); return null; 
                }
            };

            const getContext = () => {
                const monthlyIncomeTotal = incomeDetails.monthly + (incomeDetails.other||0);
                return `Ë≤°ÂãôÁãÄÊ≥Å: ${currentAge}Ê≠≤, ÈÄÄ‰ºë${retirementAge}. Á∏ΩË≥áÁî¢Ê∑®ÂÄº: ${simulationData.netWorthData[0]}. Á∏ΩË≤†ÂÇµ: ${totalLiabilities}. ÊúàÊî∂: ${monthlyIncomeTotal}. ÊúàÈñãÈä∑: ${monthlyExpensesBase}. ÊúàÈÇÑÊ¨æ: ${totalMonthlyDebtPayment}. ÊäïË≥áÊØî‰æã: ${reinvestRatio}%. ÈÄÄ‰ºëÈÅîÊàêÁéá: ${healthScore.toFixed(0)}%. Â∏ÇÂ†¥: ÂõûÂ†±${investmentReturn}%, CPI ${cpi}%.`;
            };
            
            const handleMarketAnalysis = async () => { 
                if(!apiKey) { alert("Ë´ãÂÖàËº∏ÂÖ• API Key"); return; }
                setIsMarketAnalyzing(true);
                const r = await callGemini(`ÈáùÂ∞çÁõÆÂâçË®≠ÂÆöÁöÑÂèÉÊï∏ÔºöÊäïË≥áÂõûÂ†± ${investmentReturn}%„ÄÅCPI ${cpi}%„ÄÅÊàøÁî¢Â¢ûÂÄº ${propertyGrowth}%ÔºåË´ãÂàÜÊûêÊòØÂê¶ÂêàÁêÜÔºü‰∏¶Áµ¶Âá∫Âª∫Ë≠∞„ÄÇ`);
                setIsMarketAnalyzing(false);
                if(r) { setModalContent(r); setModalOpen(true); }
            };

            const handleAIAssessment = async () => { 
                setIsAiLoading(true);
                const r = await callGemini(getContext() + " Ë´ãÂàÜÊûêÊàëÁöÑÈÄÄ‰ºëÈ¢®Èö™ËàáË≥áÁî¢ÈÖçÁΩÆÂª∫Ë≠∞. Áî®ÁπÅÈ´î‰∏≠Êñá. ÁâπÂà•Ê≥®ÊÑèÊàëÁöÑË≤∏Ê¨æÂ£ìÂäõ‰ª•ÂèäÁèæÈáëÂÜçÊäïË≥áÊØî‰æãÂ∞çË≥áÁî¢Á¥ØÁ©çÁöÑÂΩ±Èüø."); 
                setIsAiLoading(false);
                if(r) setAiMessage(r); 
            };
            
            const handleChatSend = async () => { 
                if(!chatInput.trim()) return; 
                const q = chatInput; setChatMessages(p=>[...p,{role:'user',text:q}]); setChatInput(''); setIsChatLoading(true);
                const r = await callGemini(getContext() + " ‰ΩøÁî®ËÄÖÂïè:" + q); 
                setIsChatLoading(false);
                if(r) setChatMessages(p=>[...p,{role:'ai',text:r}]); 
            };

            const formatCurrency = (val) => {
                const v = val / exchangeRate; const abs = Math.abs(v);
                let display = abs >= 100000000 ? (v/100000000).toFixed(1) + 'ÂÑÑ' : abs >= 10000 ? (v/10000).toFixed(0) + 'Ëê¨' : v.toFixed(0);
                const sym = { 'TWD':'NT$', 'USD':'US$', 'AUD':'A$', 'SGD':'S$', 'EUR':'‚Ç¨', 'JPY':'¬•', 'CNY':'¬•' };
                return `${sym[currency]||'$'}${display}`;
            };

            const getChartData = useMemo(() => {
                if (chartType === 'cashflow') {
                    return {
                        labels: simulationData.labels,
                        datasets: [
                            { label: 'Âπ¥Â∫¶Ê∑®Êî∂ÂÖ•', data: simulationData.annualIncomeData, backgroundColor: '#3b82f6', borderRadius: 2, stack: 'Stack 0' },
                            { label: 'È°çÂ§ñÊî∂ÂÖ•', data: simulationData.specialIncomeData, backgroundColor: '#8b5cf6', borderRadius: 2, stack: 'Stack 0' }, 
                            { label: 'Âπ¥Â∫¶Á∏ΩÊîØÂá∫(Âê´Ë≤∏)', data: simulationData.annualExpenseData, backgroundColor: '#f97316', borderRadius: 2, stack: 'Stack 1' },
                            { label: 'È°çÂ§ñÊîØÂá∫', data: simulationData.specialExpenseData, backgroundColor: '#ef4444', borderRadius: 2, stack: 'Stack 1' } 
                        ]
                    };
                } else if (chartType === 'composition') {
                    return {
                        labels: simulationData.labels,
                        datasets: [
                            { label: 'ÁèæÈáë', data: simulationData.compositionData.cash, backgroundColor: '#cbd5e1', fill: true },
                            { label: 'ËÇ°Á•®/Âü∫Èáë', data: simulationData.compositionData.stock, backgroundColor: '#3b82f6', fill: true },
                            { label: 'ËôõÊì¨Ë≤®Âπ£', data: simulationData.compositionData.crypto, backgroundColor: '#a855f7', fill: true },
                            { label: 'ÊàøÁî¢', data: simulationData.compositionData.realEstate, backgroundColor: '#10b981', fill: true },
                            { label: 'ÈÖçÂÅ∂Ë≥áÁî¢', data: simulationData.compositionData.spouse, backgroundColor: '#ec4899', fill: true },
                        ]
                    };
                } else if (chartType === 'velocity') {
                    return {
                        labels: simulationData.labels,
                        datasets: [
                            { 
                                label: 'ÂèØÊäïË≥áË≥áÁî¢Âπ¥Â¢ûÈáè', 
                                data: simulationData.velocityData, 
                                backgroundColor: (ctx) => {
                                    const val = ctx.raw;
                                    return val >= 0 ? '#10b981' : '#ef4444';
                                },
                                borderRadius: 2 
                            }
                        ]
                    };
                }
                return {
                    labels: simulationData.labels,
                    datasets: [
                        { label: 'ÂÆ∂Â∫≠Á∏ΩÊ∑®ÂÄº', data: simulationData.netWorthData, borderColor: '#64748b', backgroundColor: 'rgba(100,116,139,0.1)', borderWidth: 2, fill: true, pointRadius: 0, order: 3 },
                        { label: 'ÂèØÊäïË≥áË≥áÁî¢', data: simulationData.liquidAssetsData, borderColor: '#10B981', backgroundColor: 'rgba(16,185,129,0.2)', borderWidth: 2, fill: true, pointRadius: 0, order: 2 },
                        { label: 'Ë≤†ÂÇµÈ§òÈ°ç', data: simulationData.debtData, borderColor: '#F59E0B', borderWidth: 2, borderDash: [2,2], fill: false, pointRadius: 0, order: 4 },
                        { label: 'ÈÄÄ‰ºëÁõÆÊ®ôÁ∑ö', data: simulationData.targetData, borderColor: '#EF4444', borderDash: [5,5], borderWidth: 2, fill: false, pointRadius: 0, order: 1 }
                    ]
                };
            }, [simulationData, chartType]);

            const chartOptions = useMemo(() => ({
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: { legend: { position: 'bottom' }, tooltip: { callbacks: { label: (ctx) => `${ctx.dataset.label}: ${formatCurrency(ctx.parsed.y)}` } } },
                scales: { 
                    y: { ticks: { callback: (v) => formatCurrency(v) }, grid: { color: '#f3f4f6' }, stacked: chartType === 'composition' || chartType === 'cashflow' }, 
                    x: { grid: { display: false }, stacked: chartType === 'composition' || chartType === 'cashflow' } 
                },
                animation: false 
            }), [chartType, currency, exchangeRate]);

            const expenseData = {
                labels: Object.keys(expenseDetails).map(k=>EXPENSE_LABELS[k]||k),
                datasets: [{ data: Object.values(expenseDetails), backgroundColor: ['#F87171','#60A5FA','#34D399','#FBBF24','#A78BFA','#F472B6','#6366f1','#EC4899','#14B8A6','#9CA3AF', '#64748b'], borderWidth: 0 }]
            };

            return (
                <div className="min-h-screen pb-20 relative">
                    <Modal isOpen={modalOpen} onClose={() => setModalOpen(false)} title="AI Â∏ÇÂ†¥ÂèÉÊï∏ÂàÜÊûêÂ†±Âëä" content={modalContent} />
                    
                    <Modal isOpen={aiModalOpen} onClose={() => setAiModalOpen(false)} title="AI Ê∑±Â∫¶ÂÅ•Ê™¢Â†±Âëä" content={aiMessage} maxWidth="max-w-2xl" />

                    <div className="bg-slate-900 text-white p-4 shadow-lg sticky top-0 z-40 no-print">
                        <div className="flex justify-between items-center max-w-7xl mx-auto">
                            <div className="flex items-center gap-2">
                                <SimpleIcon name="Brain" className="text-blue-400" size={24}/>
                                <div><h1 className="font-bold text-lg leading-tight">AI Êô∫ËÉΩÈÄÄ‰ºëÂ∞éËà™ (Ê≠∏Èõ∂ÂàÜ‰∫´Áâà)</h1><p className="text-[10px] text-slate-400">ÂÖ¨ÈñãÂàÜ‰∫´Áâà</p></div>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={()=>setShowExchangeSettings(!showExchangeSettings)} className="bg-white/10 px-3 py-1 rounded text-xs flex items-center gap-1"><SimpleIcon name="Globe" size={12}/> {currency}</button>
                                <button onClick={() => window.print()} className="bg-white/10 px-3 py-1 rounded text-xs flex items-center gap-1 hover:bg-white/20"><SimpleIcon name="Printer" size={12}/> ÂåØÂá∫Â†±Âëä</button>
                                <div className={`px-3 py-1 rounded text-xs font-bold ${healthScore>=100?'bg-green-500/20 text-green-400':'bg-red-500/20 text-red-400'}`}>ÈÅîÊàê {healthScore.toFixed(0)}%</div>
                            </div>
                        </div>
                        {showExchangeSettings && (
                            <div className="absolute top-14 right-4 bg-white text-slate-800 p-2 rounded shadow-xl border w-64 z-50 grid grid-cols-4 gap-2">
                                {['TWD','USD','AUD','SGD','EUR','JPY','CNY'].map(c=><button key={c} onClick={()=>{setCurrency(c); const r={'TWD':1,'USD':32.5,'AUD':21,'SGD':24,'EUR':34,'JPY':0.21,'CNY':4.5}; setExchangeRate(r[c]); setShowExchangeSettings(false);}} className="text-xs p-1 bg-slate-100 rounded">{c}</button>)}
                            </div>
                        )}
                    </div>

                    <div className="max-w-7xl mx-auto p-4 md:p-6 grid grid-cols-1 lg:grid-cols-12 gap-4">
                        <div className="lg:col-span-4 space-y-4 no-print h-full flex flex-col">
                            <div className="bg-white rounded-xl shadow-sm border border-indigo-100 overflow-hidden shrink-0">
                                <div className="bg-indigo-50/50 p-3 border-b border-indigo-100 flex justify-between items-center">
                                    <h3 className="font-bold text-indigo-900 flex items-center gap-1 text-sm whitespace-nowrap"><SimpleIcon name="Sparkles" className="text-indigo-600"/> AI Ê∑±Â∫¶ÂÅ•Ê™¢</h3>
                                    <div className="flex gap-2">
                                         <button onClick={() => setAiModalOpen(true)} className="text-indigo-400 hover:text-indigo-600" title="ÊîæÂ§ßÊ™¢Ë¶ñ"><SimpleIcon name="Maximize" size={14}/></button>
                                         <button onClick={handleAIAssessment} disabled={isAiLoading} className="text-[10px] bg-indigo-600 text-white px-2 py-1 rounded disabled:opacity-50 whitespace-nowrap">
                                            {isAiLoading ? 'ÂàÜÊûê‰∏≠...' : 'ÁîüÊàêÂ†±Âëä'}
                                         </button>
                                    </div>
                                </div>
                                <div className="p-3 max-h-[120px] overflow-y-auto">
                                    {isAiLoading ? <div className="flex gap-1 justify-center"><div className="w-1.5 h-1.5 bg-indigo-400 rounded-full typing-dot"></div><div className="w-1.5 h-1.5 bg-indigo-400 rounded-full typing-dot"></div></div> : <div className="text-xs text-slate-600 prose" dangerouslySetInnerHTML={{ __html: marked.parse(aiMessage) }}></div>}
                                </div>
                            </div>

                            <div className="bg-white rounded-xl shadow-sm border border-slate-200 flex-1 flex flex-col overflow-hidden">
                                <div className="flex border-b border-slate-100 overflow-x-auto no-scrollbar">
                                    {[{id:'assets',l:'Ë≥áÁî¢',i:'Wallet'},{id:'liabilities',l:'Ë≤†ÂÇµ',i:'CreditCard'},{id:'income',l:'Êî∂ÊîØ',i:'Percent'},{id:'events',l:'Â§ß‰∫ãË®ò',i:'AlertTriangle'},{id:'stress',l:'Â£ìÂäõ',i:'Activity'}].map(t=>(
                                        <button key={t.id} onClick={()=>setActiveTab(t.id)} className={`flex-1 py-3 text-xs font-bold flex flex-col items-center gap-1 border-b-2 ${activeTab===t.id?'border-blue-500 text-blue-600 bg-blue-50':'border-transparent text-slate-400'}`}><SimpleIcon name={t.i} size={16}/><span className="whitespace-nowrap">{t.l}</span></button>
                                    ))}
                                </div>

                                <div className="p-4 overflow-y-auto flex-1 custom-scrollbar space-y-5">
                                    {activeTab === 'assets' && (
                                        <div className="space-y-4 animate-fade-in">
                                            <div className="bg-slate-100 p-2 rounded border mb-2"><input type="password" value={apiKey} onChange={e=>setApiKey(e.target.value)} placeholder="Gemini API Key (ÂøÖÂ°´)" className="w-full bg-transparent text-xs outline-none"/></div>
                                            <div>
                                                <h4 className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">ÊôÇÈñìËª∏Ë®≠ÂÆö</h4>
                                                <div className="mb-3">
                                                    <div className="flex justify-between items-center mb-1">
                                                        <label className="text-xs text-slate-600 whitespace-nowrap">Ë®≠ÂÆöÂπ¥‰ªΩ (Âü∫Ê∫ñÂπ¥)</label>
                                                        <div className="flex items-center gap-1 bg-white rounded border border-slate-300 px-2 py-1 w-32">
                                                            <SimpleIcon name="Calendar" size={14} className="text-slate-400"/>
                                                            <input type="number" value={currentYear} onChange={(e) => setCurrentYear(Number(e.target.value))} className="w-full text-right text-xs outline-none bg-transparent font-bold text-slate-700"/>
                                                            <span className="text-[10px] text-slate-400">Âπ¥</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div className="grid grid-cols-3 gap-2">
                                                    <CompactTimelineInput label="ÁèæÈΩ°" value={currentAge} onChange={setCurrentAge} min={18} max={90} unit="Ê≠≤" />
                                                    <CompactTimelineInput label="ÈÄÄ‰ºë" value={retirementAge} onChange={setRetirementAge} min={40} max={80} unit="Ê≠≤" />
                                                    <CompactTimelineInput label="Â£ΩÂëΩ" value={lifeExpectancy} onChange={setLifeExpectancy} min={80} max={110} unit="Ê≠≤" />
                                                </div>
                                            </div>
                                            <div className="bg-green-50 p-3 rounded border border-green-100">
                                                <h4 className="text-xs font-bold text-green-800 mb-2">ÊàëÁöÑË≥áÁî¢</h4>
                                                <SliderInput label="Âè∞Âπ£Áèæ" value={assets.cashTW} onChange={v=>setAssets({...assets,cashTW:Number(v)})} min={0} max={10000000} step={10000} />
                                                <SliderInput label="Â§ñÂπ£Áèæ" value={assets.cashFX} onChange={v=>setAssets({...assets,cashFX:Number(v)})} min={0} max={10000000} step={10000} />
                                                <SliderInput label="Âè∞ËÇ°" value={assets.stockTW} onChange={v=>setAssets({...assets,stockTW:Number(v)})} min={0} max={50000000} step={10000} />
                                                <SliderInput label="ÁæéËÇ°" value={assets.stockUS} onChange={v=>setAssets({...assets,stockUS:Number(v)})} min={0} max={50000000} step={10000} />
                                                <SliderInput label="ËôõÂπ£" value={assets.crypto} onChange={v=>setAssets({...assets,crypto:Number(v)})} min={0} max={10000000} step={10000} />
                                                <div className="mt-3">
                                                    <h5 className="text-xs font-bold text-green-700 mb-1 flex justify-between items-center">ÊàøÁî¢Ê∏ÖÂñÆ <span className="text-[10px] font-normal">{formatCurrency(totalRealEstateValue)}</span></h5>
                                                    {realEstateList.map(r => (
                                                        <div key={r.id} className="bg-white p-2 rounded border border-green-200 mb-1 relative group text-xs">
                                                            <button onClick={()=>removeRealEstate(r.id)} className="absolute top-1 right-1 text-slate-300 hover:text-red-500"><SimpleIcon name="Trash" size={12}/></button>
                                                            <input type="text" value={r.name} onChange={e=>updateRealEstate(r.id,'name',e.target.value)} className="font-bold bg-transparent w-20 mb-1 outline-none"/>
                                                            <div className="flex gap-2 items-center">
                                                                <input type="number" value={r.value} onChange={e=>updateRealEstate(r.id,'value',Number(e.target.value))} className="border rounded w-full p-0.5 text-xs"/>
                                                                <div className="flex items-center gap-1 shrink-0 bg-green-50 rounded px-1">
                                                                    <span className="text-[9px] text-slate-500 whitespace-nowrap">Âπ¥Â¢û</span>
                                                                    <input type="number" step="0.1" value={r.growth} onChange={e=>updateRealEstate(r.id,'growth',Number(e.target.value))} className="w-8 p-0.5 text-center text-xs bg-transparent outline-none" placeholder="%"/>
                                                                    <span className="text-[9px] text-slate-500">%</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    ))}
                                                    <button onClick={addRealEstate} className="w-full text-[10px] text-green-600 border border-dashed border-green-300 rounded py-1 hover:bg-green-50 mt-1">+ Êñ∞Â¢ûÊàøÁî¢</button>
                                                </div>
                                            </div>
                                            <div className="bg-pink-50 p-3 rounded border border-pink-100">
                                                <h4 className="text-xs font-bold text-pink-800 mb-2">ÈÖçÂÅ∂Ë≥áÁî¢</h4>
                                                <SliderInput label="ÁèæÈáë" value={assets.spouseCash} onChange={v=>setAssets({...assets,spouseCash:Number(v)})} min={0} max={10000000} step={10000} />
                                                <SliderInput label="ËÇ°Á•®" value={assets.spouseStock} onChange={v=>setAssets({...assets,spouseStock:Number(v)})} min={0} max={20000000} step={10000} />
                                                <SliderInput label="ÊàøÁî¢" value={assets.spouseRealEstate} onChange={v=>setAssets({...assets,spouseRealEstate:Number(v)})} min={0} max={50000000} step={100000} />
                                            </div>
                                        </div>
                                    )}

                                    {activeTab === 'liabilities' && (
                                        <div className="space-y-3 animate-fade-in">
                                            <div className="bg-red-100 p-3 rounded border border-red-200 mb-3 flex justify-between items-center">
                                                <span className="text-xs font-bold text-red-800">ÊØèÊúàÈÇÑÊ¨æÁ∏ΩÈ°ç</span>
                                                <span className="text-sm font-bold text-red-600">{formatCurrency(totalMonthlyDebtPayment)}</span>
                                            </div>
                                            {loans.map(l=>(
                                                <div key={l.id} className="bg-red-50 p-3 rounded border border-red-100 relative group">
                                                    <button onClick={()=>removeLoan(l.id)} className="absolute top-2 right-2 text-red-300"><SimpleIcon name="Trash" size={14}/></button>
                                                    <input type="text" value={l.name} onChange={e=>updateLoan(l.id,'name',e.target.value)} className="bg-transparent border-b border-red-200 text-xs font-bold w-full mb-2"/>
                                                    <div className="grid grid-cols-2 gap-2 mb-2">
                                                        <div><label className="text-[10px] text-slate-400">È§òÈ°ç</label><input type="number" value={l.balance} onChange={e=>updateLoan(l.id,'balance',Number(e.target.value))} className="w-full border rounded p-1 text-xs"/></div>
                                                        <div><label className="text-[10px] text-slate-400">Âà©Áéá%</label><input type="number" step="0.1" value={l.rate} onChange={e=>updateLoan(l.id,'rate',Number(e.target.value))} className="w-full border rounded p-1 text-xs"/></div>
                                                    </div>
                                                    <div className="mb-2">
                                                        <div className="flex justify-between"><label className="text-[10px] text-slate-400">ÊúüÊï∏(Êúà)</label><span className="text-[10px]">{l.months}</span></div>
                                                        <input type="range" min="0" max="360" value={l.months} onChange={e=>updateLoan(l.id,'months',Number(e.target.value))} className="w-full h-1 bg-red-200 rounded"/>
                                                    </div>
                                                    <div className="text-right text-xs font-bold text-red-600">Êúà‰ªò: {formatCurrency(calculatePMT(l.balance,l.rate,l.months))}</div>
                                                </div>
                                            ))}
                                            <button onClick={addLoan} className="w-full py-2 border border-dashed text-slate-400 rounded text-xs flex justify-center gap-1"><SimpleIcon name="Plus" size={12}/> Êñ∞Â¢ûË≤∏Ê¨æ</button>
                                        </div>
                                    )}

                                    {activeTab === 'income' && (
                                        <div className="space-y-4 animate-fade-in">
                                            <div className="bg-indigo-50 p-3 rounded border border-indigo-100">
                                                <h4 className="text-xs font-bold text-indigo-800 mb-2">Êî∂ÂÖ•</h4>
                                                <SliderInput label="ÊúàÁ∂ìÂ∏∏ÊÄßÊî∂ÂÖ•" value={incomeDetails.monthly} onChange={v=>setIncomeDetails({...incomeDetails,monthly:Number(v)})} min={0} max={500000} step={1000} />
                                                <SliderInput label="ÂÖ∂‰ªñÊúàÊî∂" value={incomeDetails.other} onChange={v=>setIncomeDetails({...incomeDetails,other:Number(v)})} min={0} max={200000} step={1000} />
                                                <div className="grid grid-cols-2 gap-2">
                                                    <SliderInput label="Âπ¥ÁµÇ(Êúà)" value={incomeDetails.bonusMonths} onChange={v=>setIncomeDetails({...incomeDetails,bonusMonths:Number(v)})} min={0} max={12} step={0.5} />
                                                    <div className="mb-3">
                                                        <div className="flex justify-between items-center mb-1"><label className="text-xs text-slate-600 whitespace-nowrap">ÊàêÈï∑%</label><div className="flex items-center gap-1 bg-white rounded border border-slate-300 px-1 w-16"><input type="number" value={incomeDetails.growth} onChange={(e) => setIncomeDetails({...incomeDetails,growth:Number(e.target.value)})} className="w-full text-right text-xs py-1 focus:outline-none bg-transparent"/></div></div><input type="range" min="0" max="10" step="0.1" value={incomeDetails.growth} onChange={(e) => setIncomeDetails({...incomeDetails,growth:Number(e.target.value)})} className="w-full" />
                                                    </div>
                                                </div>
                                                <div className="grid grid-cols-2 gap-2 border-t border-indigo-200 pt-2 mt-2">
                                                    <div><label className="text-[10px] text-slate-500">ÊàêÈï∑ÂÅúÊªØÊ≠≤Êï∏</label><input type="number" value={incomeDetails.growthEndAge} onChange={e=>setIncomeDetails({...incomeDetails,growthEndAge:Number(e.target.value)})} className="w-full border rounded text-xs p-1"/></div>
                                                    <div><label className="text-[10px] text-slate-500">ÊúàËñ™‰∏äÈôê(Cap)</label><input type="number" value={incomeDetails.maxMonthly} onChange={e=>setIncomeDetails({...incomeDetails,maxMonthly:Number(e.target.value)})} className="w-full border rounded text-xs p-1"/></div>
                                                </div>
                                                <div className="mt-2 pt-2 border-t border-indigo-200">
                                                    <div className="flex justify-between items-center mb-1">
                                                        <label className="text-xs whitespace-nowrap">ÊâÄÂæóÁ®Ö</label>
                                                        <div className="text-[10px] flex bg-white border rounded overflow-hidden">
                                                            <button onClick={()=>setTaxSettings({...taxSettings,mode:'auto'})} className={`px-2 py-1 ${taxSettings.mode==='auto'?'bg-indigo-100':''}`}>Ëá™Âãï</button>
                                                            <button onClick={()=>setTaxSettings({...taxSettings,mode:'manual'})} className={`px-2 py-1 ${taxSettings.mode==='manual'?'bg-indigo-100':''}`}>ÊâãÂãï</button>
                                                        </div>
                                                    </div>
                                                    {taxSettings.mode==='manual' && <SliderInput label="Á®ÖÁéá%" value={taxSettings.manualRate} onChange={v=>setTaxSettings({...taxSettings,manualRate:Number(v)})} min={0} max={40} />}
                                                    {taxSettings.mode==='auto' && <div className="text-[10px] bg-indigo-100 p-1 rounded text-indigo-600">È†ê‰º∞Á®Ö: {formatCurrency(calculateTaiwanTax(incomeDetails.monthly*12 + incomeDetails.monthly*incomeDetails.bonusMonths))}</div>}
                                                </div>
                                            </div>

                                            <div className="bg-pink-50 p-3 rounded border border-pink-100">
                                                <h4 className="text-xs font-bold text-pink-800 mb-2">ÈÖçÂÅ∂Êî∂ÂÖ•</h4>
                                                <SliderInput label="ÊúàÁ∂ìÂ∏∏ÊÄßÊî∂ÂÖ•" value={spouseIncomeDetails.monthly} onChange={v=>setSpouseIncomeDetails({...spouseIncomeDetails,monthly:Number(v)})} min={0} max={500000} step={1000} />
                                                <SliderInput label="ÂÖ∂‰ªñÊúàÊî∂" value={spouseIncomeDetails.other} onChange={v=>setSpouseIncomeDetails({...spouseIncomeDetails,other:Number(v)})} min={0} max={200000} step={1000} />
                                                <div className="grid grid-cols-2 gap-2">
                                                    <SliderInput label="Âπ¥ÁµÇ(Êúà)" value={spouseIncomeDetails.bonusMonths} onChange={v=>setSpouseIncomeDetails({...spouseIncomeDetails,bonusMonths:Number(v)})} min={0} max={12} step={0.5} />
                                                    <div className="mb-3">
                                                        <div className="flex justify-between items-center mb-1"><label className="text-xs text-slate-600 whitespace-nowrap">ÊàêÈï∑%</label><div className="flex items-center gap-1 bg-white rounded border border-slate-300 px-1 w-16"><input type="number" value={spouseIncomeDetails.growth} onChange={(e) => setSpouseIncomeDetails({...spouseIncomeDetails,growth:Number(e.target.value)})} className="w-full text-right text-xs py-1 focus:outline-none bg-transparent"/></div></div><input type="range" min="0" max="10" step="0.1" value={spouseIncomeDetails.growth} onChange={(e) => setSpouseIncomeDetails({...spouseIncomeDetails,growth:Number(e.target.value)})} className="w-full" />
                                                    </div>
                                                </div>
                                                <div className="grid grid-cols-2 gap-2 border-t border-pink-200 pt-2 mt-2">
                                                    <div><label className="text-[10px] text-slate-500">ÊàêÈï∑ÂÅúÊªØÊ≠≤Êï∏</label><input type="number" value={spouseIncomeDetails.growthEndAge} onChange={e=>setSpouseIncomeDetails({...spouseIncomeDetails,growthEndAge:Number(e.target.value)})} className="w-full border rounded text-xs p-1"/></div>
                                                    <div><label className="text-[10px] text-slate-500">ÊúàËñ™‰∏äÈôê(Cap)</label><input type="number" value={spouseIncomeDetails.maxMonthly} onChange={e=>setSpouseIncomeDetails({...spouseIncomeDetails,maxMonthly:Number(e.target.value)})} className="w-full border rounded text-xs p-1"/></div>
                                                </div>
                                            </div>
                                            
                                            <div className="bg-teal-50 p-3 rounded border border-teal-100">
                                                <h4 className="text-xs font-bold text-teal-800 mb-3 flex items-center gap-1"><SimpleIcon name="PieChart" size={12}/> ÁõàÈ§òÂàÜÈÖçÁ≠ñÁï•</h4>
                                                <SliderInput label="ÊØèÊúàÁõàÈ§òÊäïÂÖ•ÊäïË≥áÊØî‰æã" value={reinvestRatio} onChange={setReinvestRatio} min={0} max={100} step={5} unit="%" />
                                                <div className="flex justify-between gap-2 mt-2">
                                                    <div className="flex-1 bg-white p-2 rounded border border-teal-200 text-center">
                                                        <div className="text-[10px] text-slate-400">ÊØèÊúàÊäïË≥á (È´òÂ†±ÈÖ¨)</div>
                                                        <div className="text-xs font-bold text-teal-600">{formatCurrency(calculatedSurplus * reinvestRatio / 100)}</div>
                                                    </div>
                                                    <div className="flex-1 bg-white p-2 rounded border border-teal-200 text-center">
                                                        <div className="text-[10px] text-slate-400">ÊØèÊúàÁïôÂ≠ò (ÁèæÈáë)</div>
                                                        <div className="text-xs font-bold text-slate-600">{formatCurrency(calculatedSurplus * (1 - reinvestRatio / 100))}</div>
                                                    </div>
                                                </div>
                                            </div>

                                            <div className="bg-orange-50 p-3 rounded border border-orange-100">
                                                <h4 className="text-xs font-bold text-orange-800 mb-2 flex justify-between items-center">
                                                    <span>ÊØèÊúàÂõ∫ÂÆöÊîØÂá∫</span>
                                                    <span>{formatCurrency(monthlyExpensesBase + totalMonthlyDebtPayment)}</span>
                                                </h4>
                                                <div className="text-[10px] text-slate-500 mb-2 text-right">
                                                    (Âê´ÁîüÊ¥ª {formatCurrency(monthlyExpensesBase)} + Ë≤∏Ê¨æ {formatCurrency(totalMonthlyDebtPayment)})
                                                </div>
                                                {Object.entries(expenseDetails).map(([k,v])=>(
                                                    <div key={k} className="flex justify-between items-center text-xs mb-1">
                                                        <span className="w-16 text-slate-500">{EXPENSE_LABELS[k]}</span>
                                                        <input type="range" min="0" max="50000" step="100" value={v} onChange={e=>setExpenseDetails({...expenseDetails,[k]:Number(e.target.value)})} className="flex-1 mx-2 h-1 bg-orange-200 rounded"/>
                                                        <input type="number" value={v} onChange={e=>setExpenseDetails({...expenseDetails,[k]:Number(e.target.value)})} className="w-14 text-right border rounded"/>
                                                    </div>
                                                ))}
                                                <div className="h-20 mt-2"><ChartComponent type="doughnut" data={expenseData} options={{plugins:{legend:{display:false}}}} height={80}/></div>
                                            </div>
                                        </div>
                                    )}

                                    {activeTab === 'events' && (
                                        <div className="space-y-4 animate-fade-in">
                                            <div className="bg-purple-50 p-3 rounded border border-purple-100">
                                                <h4 className="text-xs font-bold text-purple-800 mb-3">‰∫∫ÁîüÂ§ß‰∫ãË®ò (Risk/Opportunity)</h4>
                                                <p className="text-[10px] text-slate-500 mb-3">Ë®≠ÂÆöÊú™‰æÜÂèØËÉΩÁôºÁîüÁöÑÈáçÂ§ßË≤°ÂãôËÆäÂãïÔºåÈáëÈ°çÂ∞áÈö®ÈÄöËÜ®Ë™øÊï¥„ÄÇ</p>
                                                
                                                {events.map(ev => (
                                                    <div key={ev.id} className="bg-white p-2 rounded border border-purple-100 mb-2 relative group">
                                                        <div className="absolute top-2 right-2 flex gap-1">
                                                            <button onClick={() => startEditEvent(ev)} className="text-slate-300 hover:text-blue-500"><SimpleIcon name="Edit" size={14}/></button>
                                                            <button onClick={() => removeEvent(ev.id)} className="text-slate-300 hover:text-red-500"><SimpleIcon name="Trash" size={14}/></button>
                                                        </div>
                                                        <div className="flex items-center gap-2 mb-1">
                                                            <span className={`text-[10px] px-1.5 py-0.5 rounded ${ev.type==='income'?'bg-green-100 text-green-700':'bg-red-100 text-red-700'}`}>{ev.type==='income'?'Êî∂ÂÖ•':'ÊîØÂá∫'}</span>
                                                            <span className="text-xs font-bold">{ev.name}</span>
                                                        </div>
                                                        <div className="flex justify-between text-[10px] text-slate-500">
                                                            <span>{ev.startAge}Ê≠≤ ({ev.duration}Âπ¥)</span>
                                                            <div className="flex items-center gap-1">
                                                                <span>{formatCompactNumber(ev.amount)}</span>
                                                                <span>/Âπ¥</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                ))}
                                                
                                                <div className="mt-3 pt-3 border-t border-purple-200 space-y-2">
                                                    <div className="flex justify-between items-center">
                                                        <span className="text-xs font-bold text-purple-700">{editingEventId ? 'Á∑®ËºØ‰∫ã‰ª∂' : 'Êñ∞Â¢û‰∫ã‰ª∂'}</span>
                                                        {editingEventId && <button onClick={cancelEditEvent} className="text-[10px] text-slate-400 hover:text-slate-600">ÂèñÊ∂à</button>}
                                                    </div>
                                                    <input type="text" value={newEventName} onChange={e=>setNewEventName(e.target.value)} placeholder="‰∫ã‰ª∂ÂêçÁ®± (‰æã: Áà∂ÊØçÈï∑ÁÖß)" className="w-full text-xs border rounded p-1.5" />
                                                    <div className="grid grid-cols-2 gap-2">
                                                        <select value={newEventType} onChange={e=>setNewEventType(e.target.value)} className="text-xs border rounded p-1.5 bg-white">
                                                            <option value="expense">È°çÂ§ñÊîØÂá∫ (Risk)</option>
                                                            <option value="income">È°çÂ§ñÊî∂ÂÖ• (Opp)</option>
                                                        </select>
                                                        <div className="flex items-center gap-1 border rounded p-1.5 bg-white">
                                                            <input type="number" value={newEventAmount} onChange={e=>setNewEventAmount(e.target.value)} placeholder="ÈáëÈ°ç" className="w-full text-xs outline-none" />
                                                            <span className="text-[10px] text-blue-500 whitespace-nowrap">{formatCompactNumber(newEventAmount)}</span>
                                                        </div>
                                                    </div>
                                                    <div className="grid grid-cols-2 gap-2">
                                                        <div><label className="text-[10px] text-slate-400 block">ÈñãÂßãÂπ¥ÈΩ°</label><input type="number" value={newEventAge} onChange={e=>setNewEventAge(e.target.value)} className="w-full text-xs border rounded p-1.5" /></div>
                                                        <div><label className="text-[10px] text-slate-400 block">ÊåÅÁ∫åÂπ¥Êï∏</label><input type="number" value={newEventDuration} onChange={e=>setNewEventDuration(e.target.value)} className="w-full text-xs border rounded p-1.5" /></div>
                                                    </div>
                                                    <button onClick={handleAddOrUpdateEvent} className={`w-full text-white text-xs py-1.5 rounded flex items-center justify-center gap-1 ${editingEventId ? 'bg-blue-600 hover:bg-blue-700' : 'bg-purple-600 hover:bg-purple-700'}`}>
                                                        {editingEventId ? <SimpleIcon name="Save" size={12}/> : <SimpleIcon name="Plus" size={12}/>} 
                                                        {editingEventId ? 'Êõ¥Êñ∞‰∫ã‰ª∂' : 'Êñ∞Â¢û‰∫ã‰ª∂'}
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {activeTab === 'stress' && (
                                        <div className="space-y-4 animate-fade-in">
                                            <div className="bg-slate-50 p-3 rounded border">
                                                <div className="flex justify-between mb-2">
                                                    <span className="text-xs font-bold">Â∏ÇÂ†¥ÂÅáË®≠</span>
                                                    <button onClick={handleMarketAnalysis} disabled={isMarketAnalyzing} className="text-[10px] text-blue-600 border border-blue-200 px-2 py-1 rounded bg-blue-50 hover:bg-blue-100 disabled:opacity-50 flex items-center gap-1">
                                                        {isMarketAnalyzing ? 'ÂàÜÊûê‰∏≠...' : <><SimpleIcon name="Sparkles" className="w-3 h-3"/> AI Âª∫Ë≠∞</>}
                                                    </button>
                                                </div>
                                                <SliderInput label="ÊäïË≥áÂ†±ÈÖ¨%" value={investmentReturn} onChange={setInvestmentReturn} min={1} max={15} step={0.1} />
                                                <SliderInput label="CPI%" value={cpi} onChange={setCpi} min={0} max={10} step={0.1} />
                                                <SliderInput label="ÊàøÁî¢Â¢ûÂÄº%" value={propertyGrowth} onChange={setPropertyGrowth} min={0} max={10} step={0.1} />
                                            </div>
                                            <div className="bg-yellow-50 p-3 rounded border border-yellow-100">
                                                <h4 className="text-xs font-bold text-yellow-800 mb-2">Â£ìÂäõÊ∏¨Ë©¶</h4>
                                                <div className="grid grid-cols-3 gap-1.5">
                                                    <button onClick={()=>setSensitivityMode('none')} className={`text-[10px] py-1 border rounded col-span-3 ${sensitivityMode==='none'?'bg-slate-800 text-white':'bg-white'}`}>Ê≠£Â∏∏ÊÉÖÂ¢É</button>
                                                    
                                                    <button onClick={()=>setSensitivityMode('income-10')} className={`text-[10px] py-1 border rounded ${sensitivityMode==='income-10'?'bg-yellow-200':'bg-white'}`}>Êî∂-10%</button>
                                                    <button onClick={()=>setSensitivityMode('income-20')} className={`text-[10px] py-1 border rounded ${sensitivityMode==='income-20'?'bg-yellow-300':'bg-white'}`}>Êî∂-20%</button>
                                                    <button onClick={()=>setSensitivityMode('income-30')} className={`text-[10px] py-1 border rounded ${sensitivityMode==='income-30'?'bg-yellow-400':'bg-white'}`}>Êî∂-30%</button>

                                                    <button onClick={()=>setSensitivityMode('exp+10')} className={`text-[10px] py-1 border rounded ${sensitivityMode==='exp+10'?'bg-red-100':'bg-white'}`}>ÊîØ+10%</button>
                                                    <button onClick={()=>setSensitivityMode('exp+20')} className={`text-[10px] py-1 border rounded ${sensitivityMode==='exp+20'?'bg-red-200':'bg-white'}`}>ÊîØ+20%</button>
                                                    <button onClick={()=>setSensitivityMode('exp+30')} className={`text-[10px] py-1 border rounded ${sensitivityMode==='exp+30'?'bg-red-300':'bg-white'}`}>ÊîØ+30%</button>
                                                    
                                                    <button onClick={()=>setSensitivityMode('inv-20')} className={`text-[10px] py-1 border rounded ${sensitivityMode==='inv-20'?'bg-orange-200':'bg-white'}`}>ÊäïÂ†±-20%</button>
                                                    <button onClick={()=>setSensitivityMode('inv-40')} className={`text-[10px] py-1 border rounded ${sensitivityMode==='inv-40'?'bg-orange-300':'bg-white'}`}>ÊäïÂ†±-40%</button>
                                                    
                                                    <button onClick={()=>setSensitivityMode('cpi+20')} className={`text-[10px] py-1 border rounded ${sensitivityMode==='cpi+20'?'bg-purple-200':'bg-white'}`}>CPI+20%</button>
                                                    <button onClick={()=>setSensitivityMode('cpi+40')} className={`text-[10px] py-1 border rounded col-span-2 ${sensitivityMode==='cpi+40'?'bg-purple-300':'bg-white'}`}>CPI+40%</button>
                                                    
                                                    <button onClick={()=>setSensitivityMode('inc-20_exp+20')} className={`text-[10px] py-1 border rounded col-span-3 ${sensitivityMode==='inc-20_exp+20'?'bg-orange-500 text-white':'bg-white hover:bg-orange-50'}`}>ÈõôÈáçÊâìÊìä (Êî∂-20% & ÊîØ+20%)</button>
                                                    <button onClick={()=>setSensitivityMode('inc-30_exp+30')} className={`text-[10px] py-1 border rounded col-span-3 ${sensitivityMode==='inc-30_exp+30'?'bg-red-600 text-white':'bg-white hover:bg-red-50'}`}>Ê•µÁ´ØÈ¢®Êö¥ (Êî∂-30% & ÊîØ+30%)</button>
                                                </div>
                                                {sensitivityMode !== 'none' && (
                                                    <div className="mt-2 text-[10px] text-center text-slate-500">
                                                        ÁõÆÂâçÊ®°Âºè: {sensitivityMode}
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    )}
                                </div>
                                <div className="p-3 bg-slate-50 border-t flex gap-2">
                                    <button onClick={handleExport} className="flex-1 py-2 bg-slate-200 text-xs text-slate-600 rounded flex justify-center items-center gap-1 hover:bg-slate-300"><SimpleIcon name="Download"/> ÂåØÂá∫Ë®≠ÂÆö</button>
                                    <label className="flex-1 py-2 bg-slate-200 text-xs text-slate-600 rounded flex justify-center items-center gap-1 hover:bg-slate-300 cursor-pointer">
                                        <SimpleIcon name="Upload"/> ÂåØÂÖ•Ë®≠ÂÆö
                                        <input type="file" accept=".json" onChange={handleImport} className="hidden" />
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div className="lg:col-span-8 flex flex-col gap-4 print:col-span-12">
                            <div className="grid grid-cols-2 gap-2">
                                <div className="bg-white p-3 rounded border shadow-sm"><div className="text-xs text-slate-400">ÂèØÊäïË≥áË≥áÁî¢</div><div className="text-lg font-bold text-green-600">{formatCurrency(simulationData.liquidAssetsData[retirementAge-currentAge]||0)}</div></div>
                                <div className="bg-white p-3 rounded border shadow-sm"><div className="text-xs text-slate-400">Á∏ΩÊ∑®ÂÄº</div><div className="text-lg font-bold text-slate-700">{formatCurrency(simulationData.netWorthData[retirementAge-currentAge]||0)}</div></div>
                                <div className="bg-white p-3 rounded border shadow-sm"><div className="text-xs text-slate-400">ÈÄÄ‰ºëÁõÆÊ®ô</div><div className="text-lg font-bold text-red-500">{formatCurrency(simulationData.targetData[retirementAge-currentAge]||0)}</div></div>
                                <div className="bg-white p-3 rounded border shadow-sm"><div className="text-xs text-slate-400">Áº∫Âè£</div><div className={`text-lg font-bold ${simulationData.finalLiquid>=0?'text-green-600':'text-red-600'}`}>{simulationData.finalLiquid>=0?'+':''}{formatCurrency((simulationData.liquidAssetsData[retirementAge-currentAge]-simulationData.targetData[retirementAge-currentAge])||0)}</div></div>
                            </div>
                            <div className="bg-white p-4 rounded border shadow-sm flex-1 min-h-[300px] flex flex-col">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-sm font-bold text-slate-700">Ë≥áÁî¢Ê®°Êì¨</h3>
                                    <div className="flex gap-2 no-print">
                                        <button onClick={()=>setChartType('trend')} className={`text-[10px] px-2 py-1 rounded border ${chartType==='trend'?'bg-slate-800 text-white':'bg-white text-slate-600'}`}>Ë≥áÁî¢Ë∂®Âã¢</button>
                                        <button onClick={()=>setChartType('cashflow')} className={`text-[10px] px-2 py-1 rounded border ${chartType==='cashflow'?'bg-blue-600 text-white':'bg-white text-slate-600'}`}>Êî∂ÊîØÊ¶ÇÊ≥Å</button>
                                        <button onClick={()=>setChartType('composition')} className={`text-[10px] px-2 py-1 rounded border ${chartType==='composition'?'bg-indigo-600 text-white':'bg-white text-slate-600'}`}>Ë≥áÁî¢ÈÖçÁΩÆ</button>
                                        <button onClick={()=>setChartType('velocity')} className={`text-[10px] px-2 py-1 rounded border ${chartType==='velocity'?'bg-purple-600 text-white':'bg-white text-slate-600'}`}>Ë≥áÁî¢Â¢ûÈÄü</button>
                                    </div>
                                </div>
                                <div className="flex-1 w-full"><ChartComponent type={chartType === 'trend' ? 'line' : 'bar'} data={getChartData} options={chartOptions} height={300}/></div>
                                <div className="text-[10px] text-center text-slate-400 mt-2">{sensitivityMode!=='none' && <span className="text-red-500 mr-2">[Â£ìÂäõÊ∏¨Ë©¶: {sensitivityMode}]</span>} Âπ£Âà•: {currency}</div>
                            </div>
                            
                            {/* Print Summary Block - Only visible on print */}
                            <div className="print-block mt-4 p-4 border rounded bg-white text-xs">
                                <h3 className="font-bold border-b pb-2 mb-2 text-sm">ÂèÉÊï∏Ë®≠ÂÆöÁ∏ΩË°®</h3>
                                <div className="grid grid-cols-3 gap-4">
                                    <div>
                                        <strong>Âü∫Êú¨Ë≥áÊñô</strong>
                                        <p>ÁèæÈΩ°: {currentAge}Ê≠≤ / ÈÄÄ‰ºë: {retirementAge}Ê≠≤ / Â£ΩÂëΩ: {lifeExpectancy}Ê≠≤</p>
                                        <p>Âü∫Ê∫ñÂπ¥: {currentYear}</p>
                                    </div>
                                    <div>
                                        <strong>Êî∂ÊîØÊ¶ÇÊ≥Å</strong>
                                        <p>ÊàëÁöÑÊúàÊî∂: {formatCurrency(incomeDetails.monthly)} (Âπ¥ÁµÇ{incomeDetails.bonusMonths}Êúà)</p>
                                        <p>ÈÖçÂÅ∂ÊúàÊî∂: {formatCurrency(spouseIncomeDetails.monthly)} (Âπ¥ÁµÇ{spouseIncomeDetails.bonusMonths}Êúà)</p>
                                        <p>ÊúàÁîüÊ¥ªÊîØÂá∫: {formatCurrency(monthlyExpensesBase)}</p>
                                        <p>ÊúàÈÇÑÊ¨æ: {formatCurrency(totalMonthlyDebtPayment)}</p>
                                        <p>ÊäïË≥áÊØî‰æã: {reinvestRatio}%</p>
                                    </div>
                                    <div>
                                        <strong>Ë≥áÁî¢ËàáË≤†ÂÇµ</strong>
                                        <p>Á∏ΩË≤†ÂÇµ: {formatCurrency(totalLiabilities)}</p>
                                        <p>Ê∂≤ÊÖãË≥áÁî¢: {formatCurrency(totalLiquidAssets)}</p>
                                        <p>ÊàøÁî¢Á∏ΩÂÄº: {formatCurrency(totalRealEstateValue + assets.spouseRealEstate)}</p>
                                    </div>
                                    <div>
                                        <strong>Â∏ÇÂ†¥ÂÅáË®≠</strong>
                                        <p>ÊäïË≥áÂõûÂ†±: {investmentReturn}%</p>
                                        <p>CPI: {cpi}% / ÊàøÁî¢Â¢ûÂÄº: {propertyGrowth}%</p>
                                        <p>ÊàëÁöÑËñ™Ë≥áÊàêÈï∑: {incomeDetails.growth}% (ÂÅúÊªØ:{incomeDetails.growthEndAge}Ê≠≤/‰∏äÈôê:{formatCompactNumber(incomeDetails.maxMonthly)})</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="fixed bottom-6 right-6 z-50 no-print">
                        <button onClick={()=>setShowChat(!showChat)} className="bg-blue-600 text-white p-3 rounded-full shadow-lg hover:bg-blue-700 transition"><SimpleIcon name={showChat?"ChevronDown":"MessageCircle"} size={24}/></button>
                    </div>

                    {showChat && (
                        <div className="fixed bottom-20 right-4 w-80 h-[400px] bg-white rounded-xl shadow-2xl border z-50 flex flex-col no-print">
                            <div className="p-3 bg-blue-600 text-white rounded-t-xl flex justify-between"><span className="font-bold flex items-center gap-1"><SimpleIcon name="Brain" size={16}/> È°ßÂïè</span><button onClick={()=>setChatMessages([])} className="text-xs opacity-70">Ê∏ÖÁ©∫</button></div>
                            <div className="flex-1 overflow-y-auto p-3 space-y-3 bg-slate-50">
                                {chatMessages.map((m,i)=>(<div key={i} className={`flex ${m.role==='user'?'justify-end':'justify-start'}`}><div className={`max-w-[85%] p-2 rounded text-xs ${m.role==='user'?'bg-blue-600 text-white':'bg-white border text-slate-700 prose'}`} dangerouslySetInnerHTML={{__html:marked.parse(m.text)}}></div></div>))}
                                {isChatLoading && <div className="flex justify-start"><div className="bg-white p-2 rounded border flex gap-1"><div className="w-1.5 h-1.5 bg-slate-400 rounded-full typing-dot"></div><div className="w-1.5 h-1.5 bg-slate-400 rounded-full typing-dot"></div></div></div>}
                            </div>
                            <div className="p-2 border-t flex gap-2"><input type="text" value={chatInput} onChange={e=>setChatInput(e.target.value)} onKeyDown={e=>e.key==='Enter'&&handleChatSend()} placeholder="Ëº∏ÂÖ•ÂïèÈ°å..." className="flex-1 border rounded px-2 py-1 text-xs"/><button onClick={handleChatSend} className="bg-blue-600 text-white p-1.5 rounded"><SimpleIcon name="Send" size={14}/></button></div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<RetirementApp />);
    </script>
</body>
</html>